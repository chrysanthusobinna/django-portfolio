{% if user.is_authenticated %}
<!-- Floating Action Buttons -->
<div class="floating-actions">
    <!-- Back Button (always show) -->
    <a href="{% url 'home' %}#templates" class="floating-btn" title="Back to Templates">
        <i class="fas fa-arrow-left me-1"></i> Back
    </a>
    
    <!-- Use Template Button (only on template preview pages) -->
    {% if template_id %}
    <button class="floating-btn" onclick="confirmUseTemplate({{ template_id }})" title="Use This Template">
        <i class="fas fa-check me-1"></i> Use Template
    </button>
    {% endif %}
    
    <!-- Edit Profile Button (only on user's own profile) -->
    {% if is_owner %}
    <a href="{% url 'edit_user_profile' user.username %}" class="floating-btn" title="Edit Profile">
        <i class="fas fa-edit me-1"></i> Edit
    </a>
    {% endif %}
    
    <!-- Logout Button -->
    <button class="floating-btn" onclick="confirmLogout()" title="Logout">
        <i class="fas fa-sign-out-alt me-1"></i> Logout
    </button>
</div>

<!-- Confirmation Modal -->
<div class="modal fade" id="confirmModal" tabindex="-1" aria-labelledby="confirmModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="confirmModalLabel">Confirm Action</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="confirmModalBody">
                <!-- Dynamic content -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirmModalAction">Confirm</button>
            </div>
        </div>
    </div>
</div>

<style>
.floating-actions {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 1000;
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.floating-btn {
    background: #1a1a2e;
    color: #c9a96e;
    padding: 8px 16px;
    border-radius: 4px;
    text-decoration: none;
    font-size: 0.85rem;
    font-weight: 500;
    transition: all 0.3s;
    border: 1px solid #c9a96e;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    text-align: center;
    min-width: 120px;
}

.floating-btn:hover {
    background: #c9a96e;
    color: #1a1a2e;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.floating-btn a {
    color: inherit;
    text-decoration: none;
}
</style>

<script>
function confirmUseTemplate(templateId) {
    const modal = new bootstrap.Modal(document.getElementById('confirmModal'));
    document.getElementById('confirmModalLabel').textContent = 'Use This Template';
    document.getElementById('confirmModalBody').innerHTML = `
        <p>Are you sure you want to use this template for your portfolio?</p>
        <p class="text-muted">This will replace your current template selection.</p>
    `;
    
    const actionBtn = document.getElementById('confirmModalAction');
    actionBtn.textContent = 'Use Template';
    actionBtn.className = 'btn btn-primary';
    actionBtn.onclick = function() {
        useTemplate(templateId);
        modal.hide();
    };
    
    modal.show();
}

function useTemplate(templateId) {
    fetch(`/select-template/${templateId}/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('Template selected successfully!', 'success');
            setTimeout(() => {
                window.location.href = `/${user.username}/`;
            }, 1500);
        } else {
            showNotification(data.message || 'Error selecting template', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Error selecting template', 'error');
    });
}

function confirmLogout() {
    const modal = new bootstrap.Modal(document.getElementById('confirmModal'));
    document.getElementById('confirmModalLabel').textContent = 'Logout';
    document.getElementById('confirmModalBody').innerHTML = `
        <p>Are you sure you want to logout?</p>
    `;
    
    const actionBtn = document.getElementById('confirmModalAction');
    actionBtn.textContent = 'Logout';
    actionBtn.className = 'btn btn-danger';
    actionBtn.onclick = function() {
        logout();
        modal.hide();
    };
    
    modal.show();
}

function logout() {
    fetch('/logout/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('Logged out successfully!', 'success');
            setTimeout(() => {
                window.location.href = '/';
            }, 1000);
        } else {
            showNotification(data.message || 'Error logging out', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Error logging out', 'error');
    });
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function showNotification(message, type) {
    var icon = type === 'success' ? 'success' : 'error';
    var heading = type === 'success' ? 'Success' : 'Error';
    var loaderBg = type === 'success' ? '#2ecc71' : '#e74c3c';
    
    $.toast({
        heading: heading,
        text: message,
        icon: icon,
        position: 'top-right',
        showHideTransition: 'slide',
        allowToastClose: true,
        hideAfter: 5000,
        stack: 5,
        loader: true,
        loaderBg: loaderBg
    });
}
</script>
{% endif %}
